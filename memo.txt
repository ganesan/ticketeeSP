#Things to do
1)Prepare template css for development
2)Use bootstrap twitter css for development

#Learning Rails
##Create new apps
rails new ticketeeSP
or 
rails new ticketeeSP -T -d mysql


##Add repos to git
git init
git add .
git commit -a -m 'Initial Commit'
git remote add origin git@github.com:ganesan/ticketee.git
git push origin master -u


##Edit Gemfile
source 'http://rubygems.org'

gem 'rails', '3.1.3'
gem 'sqlite3'
# Gems used only for assets and not required
# in production environments by default.
group :assets do
  gem 'sass-rails',   '~> 3.1.5'
  gem 'coffee-rails', '~> 3.1.1'
  gem 'uglifier', '>= 1.0.3'
end

gem 'jquery-rails'

group :test, :development do
  gem 'rspec-rails', '~> 2.5'
end

group :test do
  #refer errata
  gem 'cucumber-rails', '1.0.6'
  gem 'capybara'
  gem 'database_cleaner'
end

##Prepare and install gems
bundle install


## --binstubs
bundle install --binstubs

## install cucumber
rails generate cucumber:install
or
r g cucumber:install

## install rspec
r g rspec:install

## Database configuration
edit the file 
config/database.yml
### sqlite3
development:
  adapter:sqlite3
  database:db/development.sqlite3
  pool: 5
  timeout: 5000

### postgresql
development:
  adapter: postgresql
  database: ticketee_development
  username: root
  password: password

### mysql
development:
  adapter: mysql2
  database: ticketee_development
  username: root
  password: password
  encoding: utf8

## Create db
rake db:migrate

--Finish preparation--

#Preparing for development
#First Step
##Create a feature file (features/creating_projects.feature)

Feature: Creating projects
  In order to have projects to assign tickets to 
  As a user
  I want to create them easily
  
  Scenario: Creating a project
    Given I am on the homepage
    When I follow "New Project"
    And I fill in "Name" with "TextMate 2"
    And I press "Create Project"
    Then I should see "Project has been created."


## Run rake cucumber:ok command
  rake cucumber:ok
  or
  rock

## First thing to do 
   delete public/index.html
   rm public/index.html

## Edit path to root at routes.rb
   root :to => "projects#index"

## Create project controller
r g controller projects
or 
rgc projects

## The action 'index' could not be found for ProjectsController ...
Given I am on the homepage
  The action 'index' could not be found for ProjectsController ...

edit the projects controller file app/controllers/projects_controller.rb

def index
end

## Missing template warning
Given I am on the homepage
Missing template projects/index, application/index
  with {:handlers=>[:erb, :builder],
        :formats=>[:html],
        :locale=>[:en, :en]}.
  Searched in:
    * ".../ticketee/app/views"



create a file at view/projects/index.html.erb


#Given I am on the homepage
    When I follow "New Project"
      no link with title, id or text 'New Project' found


## How to create link_to on erb
<%= link_to "New Project", new_project_path %>

## Add routes to config/routes.rb file
resources :projects

## Creating Model
rails g model project name:string


##Preparing Partial Forms
new.html.erb
<h2>New Project</h2>
<%= render 'form' %>


## How to create a form in erb (partial file: _form.html.erb )

<%= form_for(@project) do |f| %>
  <p>
    <%= f.label :name %>
    <%= f.text_field :name %>
  </p>
  <%= f.submit %>
<% end %>


## And I press "Create Project"
      The action 'create' could not be found for ProjectsController (AbstractController::ActionNotFound)

Automatically know that post action will call create methods


## create methods in the controller
def create
  @project = Project.new(params[:project])
  @project.save
  flash[:notice] = "Project has been created."
  redirect_to @project
end

## show method
def show
	@project = Project.find(params[:id])
end

## show the result in show.html.erb
<h2><%= @project.name %></h2>




## show flash notice edit application.html.erb
add 
<% flash.each do |key, value| %>
   <div class='flash' id='<%= key %>'>
     <%= value %>
   </div>
<% end %>

before <%= yield %>


#Validation

##Preparation
Change the Gemfile
gem 'dynamic_form'

##Change the model/project.rb
In the model
  validates :name, :presence => true

## Change the create method for validation
def create
  @project = Project.new(params[:project])
  if @project.save
    flash[:notice] = "Project has been created."
    redirect_to @project
  else
    flash[:alert] = "Project has not been created."
    render :action => "new"
  end
end

## Edit _form.html.erb 
should be changed to 
<%=form_for(@project) do |f| %>
* <%= f.error_messages %>
	<p>
		<%= f.label :name %>
		<%= f.text_field :name %>
	</p>
	<%= f.submit %>
<% end %>


#Viewing List of CRUD (READ)
## feature/viewing_project.feature
Feature: Viewing projects
  In order to assign tickets to a project
  As a user
  I want to be able to see a list of available projects
  I want to be able to navigate from the project list

Scenario: Listing all the projects
  Given there is a project called "TextMate 2"
  And I am on the homepage
  When I follow "TextMate 2"
  Then I should be on the project page for "TextMate 2"

##Using Factory_girl
Add           gem 'factory_girl' 
to Gemfile
group :test do
end
would be good


## How to use Factory_girl
  Project.create(:name => name) is how you create a new instance
This is how
  Factory(:project, :name => name)

##Factory not registered: project (ArgumentError)

## Where to put the factory files
root/factories/


## features/support/factories.rb so that it will load automatically each time 
## Cucumber starts
Dir[Rails.root + "factories/*.rb"].each do |file|
  require file
end

## Creating Link
<%= link_to project.name, project %>

<h2>Projects</h2>
<ul>
	<% @projects.each do |project| %>
	<li><%= link_to project.name, project%></li>
	<% end %>
</ul>

<%= link_to "New Project", new_project_path %>



## Instance not set
You have a nil object when you didn't expect it!
You might have expected an instance of Array.

def index
   @projects = Project.all
end



# Edit 
The edit_project_path method generates the link to the Project object, pointing at the ProjectsController’s edit action. This method is provided to you because of the resources :projects line in config/routes.rb.

<%= link_to "Edit Project", edit_project_path(@project) %>

def edit
  @project = Project.find(params[:id])
end


# Update

def update
@project = Project.find(params[:id])
  if @project.update_attributes(params[:project])
    flash[:notice] = "Project has been updated."
    redirect_to @project
  else
    flash[:alert] = "Project has not been updated."
    render :action => "edit"
  end
end

@project.update_attributes(params[:project])
returns true if updated, false if fails


# Delete
Feature: Deleting Projects
  In order to remove needless projects
  As a project manager
  I want to be able to delete them

Scenario: Deleting a project
  Given there is a project called "TextMate 2"
  And I am on the homepage
  When I follow "TextMate 2"
  And I follow "Delete Project"
  Then I should see "Project has been deleted."
  Then I should not see "TextMate 2"


## Add to show
<%= link_to "Delete Project", @project, :method => :delete,
  :confirm => "Are you sure you want to delete this project?" %>

## destroy methods
def destroy
   @project = Project.find(params[:id])
   @project.destroy
   flash[:notice] = "Project has been deleted."
   redirect_to projects_path
end


## About redirect
  redirect_to projects_path
  will redirect to
  /projects




# How to run in production environment
rake db:migrate RAILS_ENV=production
rake assets:precompile
rails server -e production


Due to asset serving having been turned off automatically in the production environment, assets will need to be precompiled by running rake assets:precompile before launching the server in production. If this is not run, the styles for the application will be missing.


# Looking for a page that is not there
this is done over in rspec 



#Using before filter
before_filter :find_project, :only =>[:show, :edit, :update, :destroy]

private
  def find_project
    @project = Project.find(params[:id])
    rescue ActiveRecord::RecordNotFound
    flash[:alert] = "The project you were looking for count not be found."
    redirect_to projects_path
  end


######################################################
# Nested Resource
# features/creating_tickets.feature
######################################################
Feature: Creating Tickets
In order to create tickets for projects
As a user
I want to be able to select a project and do that
Background:
  Given there is a project called "Internet Explorer"
  And I am on the homepage
  When I follow "Internet Explorer"
  And I follow "New Ticket"
Scenario: Creating a ticket
  When I fill in "Title" with "Non-standards compliance"
  And I fill in "Description" with "My pages are ugly!"
  And I press "Create Ticket"
  Then I should see "Ticket has been created."
Scenario: Creating a ticket without valid attributes fails
  When I press "Create Ticket"
  Then I should see "Ticket has not been created."
  And I should see "Title can't be blank"
And I should see "Description can't be blank"


## @ticket = @project.tickets.build

class TicketsController < ApplicationController
  before_filter :find_project
  
  def new
    @ticket = @project.tickets.build
  end

  # Where does params[:project_id] come from? 
  # It’s made available through the wonders of 
  # Rails’s routing, just as params[:id] was. 
  # It’s called project_id instead of id because 
  # you could (and later will) have a route that you want to pass 
  # through an ID for a ticket as well, 
  # and that would be params[:id]. 
  # Now how about that tickets method on your @project object? 
  # Let’s make sure it doesn’t already exist by running 
  # bin/ cucumber features/creating_tickets.feature:

  private
    def find_project
      @project = Project.find(params[:project_id])
    end
end


Where does params[:project_id] come from? It’s made available through the wonders of Rails’s routing, just as params[:id] was. It’s called project_id instead of id because you could (and later will) have a route that you want to pass through an ID for a ticket as well, and that would be params[:id]. Now how about that tickets method on your @project object? Let’s make sure it doesn’t already exist by running bin/ cucumber features/creating_tickets.feature:





## has_many association

has_many :tickets

this defines the tickets method, and also build methods 
build method is equivalent to new for the Ticket class but  associates the new bject instantly with the @project object by setting a foreign key called project_id automatically.

## Uninitialized constant Project::Ticket (NameError)

rails generate model ticket title:string description:text project:references

the project:references defines an integer column for the tickets table called project_id
in the migration
this column represents the project this ticket links to and is called a foreign key

### to load new schema
rake db:migrate
### to load new schema for the test
rake db:test:prepare

every time you add a foreign ref keys you should also recreate the test db

### Using the form_for

<%= form_for [@project, @ticket] do |f| %>
	<%= f.error_message %>
	<p>
		<%= f.label :title %><br>
		<%= f.text_field :title %><br>
	</p>
	<p>
		<%= f.label :description %><br>
		<%= f.text_area :description %><br>
	</p>
	<%= f.submit %>
<% end %>

form_for is passed an array of object rather than simply 
<%= form_for @ticket do |f| %>

### <%= form_for [@project, @ticket] do |f| %>
indicates to form_for that you want the form to post to the nested route you're using

For the new action this generate a route like /projects/1/tickets and for the edit action it generates a route like /projects/1/tickets/2


## create function
def create
  @ticket = @project.tickets.build(params[:ticket])
  if @ticket.save
    flash[:notice] = "Ticket has been created."
    redirect_to [@project, @ticket]
  else
    flash[:alert] = "Ticket has not been created."
    render :action => "new"
  end
end


inside this action, redirect_to [@project, @ticket] and specify and Array the same array you used in the form_for, containing a Project object and a Ticket object.

rails determine that you want this helper
project_ticket_path(@project, @ticket)

you could specify project_ticket_path in the action but redirect_to [@project, @ticket]
is DRYer.

Find ticket associated to a project
def find_ticket
          @ticket = @project.tickets.find(params[:id])
end



find is yet another association method provided by Rails when you declared that your Project model has_many :tickets. 


### http://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html

before_filter :find_ticket, :only => [:show,
                                              :edit,
                                              :update,
                                              :destroy]


<div id='ticket'>
 <h2><%= @ticket.title %></h2>
 <%= simple_format(@ticket.description) %>
</div>



validation
validates :title, :presence => true
validates :description, :presence => true


## Validation of length
validates :description, :presence => true, :length => { :minimun => 10}

go to console 
r console

and in console
> Ticket.create! 

This will give out and error message.

Result:
ActiveRecord::RecordInvalid: Validation failed: Title can't be blank, Description can't be blank, Description is too short (minimum is 10 characters)

The third part is the result of output.

Description can't be blank, Description is too short (minimum is 10 characters)

this must be in the cucumber feature file.



















